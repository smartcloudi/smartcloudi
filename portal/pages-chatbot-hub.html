<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Tell the browser to be responsive to screen width -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <!-- Favicon icon -->
    <link rel="icon" type="image/ico" sizes="16x16" href="../images/favicon.ico">
    <title>Smart Cloudi - Chatbot Hub</title>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-136094582-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-136094582-1');
    </script>
    <!-- Custom CSS -->
    <link href="css/style.min.css" rel="stylesheet">
    <link href="../css/stylish-tooltip.css" rel="stylesheet">
    <link href="../css/switchery.css" rel="stylesheet" />
    <link href="../css/jquery-ui.min.css" rel="stylesheet" />
    <link href="../css/jquery.toast.min.css" rel="stylesheet">
    <link href="../css/perfect-scrollbar.css">
    <!-- page css -->
    <link href="css/inbox.css" rel="stylesheet">
    <link rel="stylesheet" href="css/pages-chatbot-hub.css">
</head>

<body class="skin-purple-dark fixed-layout">
    <!-- ============================================================== -->
    <!-- Preloader - style you can find in spinners.css -->
    <!-- ============================================================== -->
    <div class="preloader">
        <div class="loader">
            <div class="loader__figure"></div>
            <p class="loader__label">Smart Cloudi</p>
        </div>
    </div>
    <!-- ============================================================== -->
    <!-- Main wrapper - style you can find in pages.scss -->
    <!-- ============================================================== -->
    <div id="main-wrapper">
        <div id="topbar"></div>
        <div id="leftsidebar"></div>
        <!-- ============================================================== -->
        <!-- Page wrapper  -->
        <!-- ============================================================== -->
        <div class="page-wrapper">
            <!-- ============================================================== -->
            <!-- Container fluid  -->
            <!-- ============================================================== -->
            <div class="container-fluid">
                <!-- ============================================================== -->
                <!-- Bread crumb and right sidebar toggle -->
                <!-- ============================================================== -->
                <div class="row page-titles">
                    <div class="col-md-5 align-self-center">
                        <h4 class="text-themecolor">Chatbot Hub</h4>
                    </div>
                    <div class="col-md-7 align-self-center text-right">
                        <div class="d-flex justify-content-end align-items-center">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                                <li class="breadcrumb-item active">Chatbot Hub</li>
                            </ol>
                            <button type="button" data-toggle="modal" data-target="#settings" class="btn btn-info d-none d-lg-block m-l-15"><i class="fa fa-plus-circle"></i> Create
                                New</button>
                        </div>
                    </div>
                </div>
                <!-- ============================================================== -->
                <!-- End Bread crumb and right sidebar toggle -->
                <!-- ============================================================== -->
            </div>
            <!-- Settings Modal -->
            <div id="settings" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="settingsLabel" aria-hidden="true" style="display: none;">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="title"></h4>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        </div>
                        <div class="modal-body">
                            <p class="text-center">Add channels, bots and (optionally) operators to your chatbot hub</p>
                            <p class="text-center">Select the primary bot to use for new conversations</p>
                            <hr />
                            <form id="new-request">
                                <div>
                                    <div class="form-group">
                                        <label for="name">Name</label>
                                        <input type="text" class="form-control" id="name" name="name" required placeholder="Enter a name for your chatbot configuration">
                                    </div>
                                    <div class="form-group" id="channels" name="channels">
                                        <label class="col-2 text-right">Channels</label>
                                        <div class="btn-group" role="group">
                                            <button type="button" data-toggle="modal" data-target="#web" class="btn btn-default d-none d-lg-block ml-2"><i class="fas fa-1x fa-globe" title="Web"></i> Web <i class="fas fa-plus-circle"></i></button>
                                            <button type="button" id="facebookmessengerchannel" data-toggle="modal" data-target="#facebookmessenger" class="btn btn-default d-none d-lg-block ml-2"><i class="fab fa-1x fa-facebook-messenger" style="color: #0078ff" title="Facebook Messenger"></i> Facebook Messenger <i id="facebookmessengerchannelsign" class="fas fa-plus-circle"></i></button>
                                            <button type="button" id="facebookmessengerchannelreset" class="btn btn-small bg-danger"><i class="fas fa-times text-white"></i> </button>
                                            <button type="button" id="skypechannel" data-toggle="modal" data-target="#skype" class="btn btn-default d-none d-lg-block ml-2"><i class="fab fa-1x fa-skype" style="color: #00aff0" title="Skype"></i> Skype <i class="fas fa-plus-circle"></i></button>
                                            <button type="button" id="skypechannelreset" class="btn btn-small bg-danger"><i class="fas fa-times text-white"></i> </button>
                                        </div>
                                    </div>
                                    <div class="form-group" id="bots" name="bots">
                                        <label class="col-2 text-right">Bots</label>
                                        <div class="btn-group" role="group">
                                            <button type="button" id="azurebotchannel" data-toggle="modal" data-target="#azurebot" class="btn btn-default d-none d-lg-block ml-2">Azure Bot <i id="azurebotchannelsign" class="fas fa-plus-circle"></i></button>
                                            <button type="button" id="azurebotchannelreset" class="btn btn-small bg-danger"><i class="fas fa-times text-white"></i> </button>
                                            <button type="button" id="googledialogflowchannel" data-toggle="modal" data-target="#googledialogflow" class="btn btn-default d-none d-lg-block ml-2">Google DialogFlow <i id="googledialogflowchannelsign" class="fas fa-plus-circle"></i></button>
                                            <button type="button" id="googledialogflowchannelreset" class="btn btn-small bg-danger"><i class="fas fa-times text-white"></i> </button>
                                            <button type="button" id="ibmwatsonchannel" data-toggle="modal" data-target="#ibmwatson" class="btn btn-default d-none d-lg-block ml-2">IBM Watson <i id="ibmwatsonchannelsign" class="fas fa-plus-circle"></i></button>
                                            <button type="button" id="ibmwatsonchannelreset" class="btn btn-small bg-danger"><i class="fas fa-times text-white"></i> </button>
                                        </div>
                                    </div>
                                    <div class="form-group" id="operators" name="operators">
                                        <label class="col-2 text-right">Operators</label>
                                        <div class="btn-group" role="group">
                                            <button type="button" id="genesyspurecloudchannel" data-toggle="modal" data-target="#genesyspurecloud" class="btn btn-default d-none d-lg-block ml-2">Genesys PureCloud <i id="genesyspurecloudchannelsign" class="fas fa-plus-circle"></i></button>
                                            <button type="button" id="genesyspurecloudchannelreset" class="btn btn-small bg-danger"><i class="fas fa-times text-white"></i> </button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-2 text-right">Primary Bot: </label>
                                        <select id="primaryOutput" name="primaryOutput">
                                            <option value=""></option>
                                            <option value="azurebot">Azure Bot</option>
                                            <option value="genesyspurecloud">Genesys PureCloud</option>
                                            <option value="googledialogflow">Google DialogFlow</option>
                                            <option value="ibmwatson">IBM Watson</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <div id="error" class="text-danger">
                                <span></span>
                            </div>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="button" id="close" class="btn btn-primary waves-effect"></button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Settings Modal -->

            <!-- Facebook Messenger Modal -->
            <div id="facebookmessenger" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="facebookMessengerLabel" aria-hidden="true" style="display: none;">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="title">Facebook Messenger</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        </div>
                        <div class="modal-body">
                            <form id="new-request-facebookmessenger">
                                <div>
                                    <div class="form-group">
                                        <label for="facebookMessengerPageAccessToken">Page Access Token</label>
                                        <small class="text-info"> Get it from <a href="https://developers.facebook.com" target="_blank">developers.facebook.com</a>, under Messenger/Settings </small>
                                        <input type="text" class="form-control" id="facebookMessengerPageAccessToken" name="facebookMessengerPageAccessToken" required placeholder="Enter your Page Access Token">
                                    </div>
                                    <div class="form-group">
                                        <label for="facebookMessengerPageId">Page Id</label>
                                        <small class="text-info"> Get it from your page under "About" or from your page URL</small>
                                        <input type="text" class="form-control" id="facebookMessengerPageId" name="facebookMessengerPageId" required placeholder="Enter your Page Id (e.g. 1203344329828483)">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <div id="error" class="text-danger">
                                <span></span>
                            </div>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="button" id="close" class="btn btn-primary waves-effect">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Facebook Messenger Modal -->

            <!-- Skype Modal -->
            <div id="skype" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="SkypeLabel" aria-hidden="true" style="display: none;">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="title">Skype</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        </div>
                        <div class="modal-body">
                            <form id="new-request-skype">
                                <div>
                                    <div class="form-group">
                                        <label for="skypePageAccessToken">Page Access Token</label>
                                        <small class="text-info"> Get it from <a href="https://developers.facebook.com" target="_blank">developers.facebook.com</a>, under Messenger/Settings </small>
                                        <input type="text" class="form-control" id="skypePageAccessToken" name="skypePageAccessToken" required placeholder="Enter your Page Access Token">
                                    </div>
                                    <div class="form-group">
                                        <label for="skypePageId">Page Id</label>
                                        <small class="text-info"> Get it from your page under "About" or from your page URL</small>
                                        <input type="text" class="form-control" id="skypePageId" name="skypePageId" required placeholder="Enter your Page Id (e.g. 1203344329828483)">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <div id="error" class="text-danger">
                                <span></span>
                            </div>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="button" id="close" class="btn btn-primary waves-effect">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Skype Modal -->

            <!-- Azure Bot Modal -->
            <div id="azurebot" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="azurebotLabel" aria-hidden="true" style="display: none;">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="title">Azure Bot</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        </div>
                        <div class="modal-body">
                            <form id="new-request-azurebot">
                                <div>
                                    <div class="form-group">
                                        <label for="azurebotApiKey">Secret Key</label>
                                        <input type="text" class="form-control" id="azurebotApiKey" name="azurebotApiKey" required placeholder="Enter your Secret Key">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <div id="error" class="text-danger">
                                <span></span>
                            </div>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="button" id="close" class="btn btn-primary waves-effect">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Azure Bot Modal -->

            <!-- Google Dialogflow Modal -->
            <div id="googledialogflow" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="googledialogflowLabel" aria-hidden="true" style="display: none;">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="title">IBM Watson</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        </div>
                        <div class="modal-body">
                            <form id="new-request-googledialogflow">
                                <div>
                                    <div class="form-group">
                                        <label for="googledialogflowApiKey">API Key</label>
                                        <input type="text" class="form-control" id="googledialogflowApiKey" name="googledialogflowApiKey" required placeholder="Enter your API Key">
                                    </div>
                                    <div class="form-group">
                                        <label for="googledialogflowUrl">URL</label>
                                        <input type="text" class="form-control" id="googledialogflowUrl" name="googledialogflowUrl" required placeholder="Enter your URL">
                                    </div>
                                    <div class="form-group">
                                        <label for="googledialogflowWorkspaceId">Workspace Id</label>
                                        <input type="text" class="form-control" id="googledialogflowWorkspaceId" name="googledialogflowWorkspaceId" required placeholder="Enter your Workspace Id">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <div id="error" class="text-danger">
                                <span></span>
                            </div>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="button" id="close" class="btn btn-primary waves-effect">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Google Dialogflow Modal -->

            <!-- IBM Watson Modal -->
            <div id="ibmwatson" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="ibmWatsonLabel" aria-hidden="true" style="display: none;">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="title">IBM Watson</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        </div>
                        <div class="modal-body">
                            <form id="new-request-ibmwatson">
                                <div>
                                    <div class="form-group">
                                        <label for="ibmWatsonApiKey">API Key</label>
                                        <input type="text" class="form-control" id="ibmWatsonApiKey" name="ibmWatsonApiKey" required placeholder="Enter your API Key">
                                    </div>
                                    <div class="form-group">
                                        <label for="ibmWatsonUrl">URL</label>
                                        <input type="text" class="form-control" id="ibmWatsonUrl" name="ibmWatsonUrl" required placeholder="Enter your URL">
                                    </div>
                                    <div class="form-group">
                                        <label for="ibmWatsonWorkspaceId">Workspace Id</label>
                                        <input type="text" class="form-control" id="ibmWatsonWorkspaceId" name="ibmWatsonWorkspaceId" required placeholder="Enter your Workspace Id">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <div id="error" class="text-danger">
                                <span></span>
                            </div>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="button" id="close" class="btn btn-primary waves-effect">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End IBM Watson Modal -->

            <!-- PureCloud Modal -->
            <div id="genesyspurecloud" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="pureCloudLabel" aria-hidden="true" style="display: none;">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="title">Genesys PureCloud</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        </div>
                        <div class="modal-body">
                            <form id="new-request-genesyspurecloud">
                                <div>
                                    <div class="form-group">
                                        <label for="pureCloudOrganizationId">Organization Id</label>
                                        <input type="text" class="form-control" id="pureCloudOrganizationId" name="pureCloudOrganizationId" required placeholder="Enter your Organization Id">
                                    </div>
                                    <div class="form-group">
                                        <label for="pureCloudDeploymentId">Deployment Id</label>
                                        <input type="text" class="form-control" id="pureCloudDeploymentId" name="pureCloudDeploymentId" required placeholder="Enter your Web Chat Deployment Id">
                                    </div>
                                    <div class="form-group">
                                        <label>Environment: </label>
                                        <select id="pureCloudEnvironment">
                                            <option value=""></option>
                                            <option value="mypurecloud.com">mypurecloud.com (Americas)</option>
                                            <option value="mypurecloud.com.au">mypurecloud.com.au (Australia/New
                                                Zealand)</option>
                                            <option value="mypurecloud.de">mypurecloud.de (EU/Frankfurt)</option>
                                            <option value="mypurecloud.ie">mypurecloud.ie (EU/Ireland)</option>
                                            <option value="mypurecloud.jp">mypurecloud.jp (Japan)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="pureCloudQueueName">Queue Name</label>
                                        <input type="text" class="form-control" id="pureCloudQueueName" name="pureCloudQueueName" required placeholder="Enter the name of the queue to send messages to">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <div id="error" class="text-danger">
                                <span></span>
                            </div>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="button" id="close" class="btn btn-primary waves-effect">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End PureCloud Modal -->

            <!-- ============================================================== -->
            <!-- Start Page Content -->
            <!-- ============================================================== -->
            <!-- Alert -->
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                Thank you for using our Chatbot Hub. Click on the <strong>Create New</strong> button on the top-right to
                get started.
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <!-- Page Content -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="row">
                            <div class="col-lg-3 col-md-4">
                                <div class="card-body inbox-panel">
                                    <ul class="list-group list-group-full">
                                        <li class="list-group-item active"> <a href="javascript:void(0)" id="showAll"><i class="fas fa-folder"></i> All </a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-lg-9 col-md-8 bg-light border-left">
                                <div class="card-body">
                                    <button type="button" id="refresh" class="btn btn-secondary mr-2 shadow-sm"><i class="fas fa-sync-alt"></i></button>
                                </div>

                                <div class="container">
                                    <div id="accordion">
                                        <!-- This is where requests will be added dynamically -->
                                    </div>
                                </div>

                                <div class="card-body p-t-0">
                                    <div class="card b-all shadow-none">
                                        <div class="inbox-center table-responsive">
                                            <table class="table table-hover no-wrap">
                                                <tbody id="requests">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ============================================================== -->
            <!-- End Page Content -->
            <!-- ============================================================== -->
            <!-- ============================================================== -->
            <!-- Right sidebar -->
            <!-- ============================================================== -->
            <div id="rightsidebar"></div>
            <!-- ============================================================== -->
            <!-- End Right sidebar -->
            <!-- ============================================================== -->
        </div>
        <!-- ============================================================== -->
        <!-- End Container fluid  -->
        <!-- ============================================================== -->
    </div>
    <!-- ============================================================== -->
    <!-- End Page wrapper  -->
    <!-- ============================================================== -->
    <div id="footer"></div>
    </div>
    <!-- ============================================================== -->
    <!-- End Wrapper -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- All Jquery -->
    <!-- ============================================================== -->
    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../js/popper.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>

    <script src="../js/perfect-scrollbar.min.js"></script>
    <script src="../js/perfect-scrollbar.jquery.js"></script>

    <script src="../js/jquery-ui.min.js"></script>

    <script src="../js/waves.js"></script>
    <script src="../js/sidebarmenu.js"></script>

    <script src="../js/jquery.magnific-popup.min.js"></script>
    <script src="../js/jquery.nav.js"></script>

    <script src="../js/jquery.toast.min.js"></script>
    <script src="../js/sweetalert.min.js"></script>

    <script src="../js/jquery.validate.min.js"></script>
    <script src="../js/additional-methods.min.js"></script>

    <script src="../js/moment.min.js"></script>
    <script src="../js/later.min.js"></script>
    <script src="../js/prettycron.js"></script>
    <script src="../js/cron-ui.min.js"></script>

    <!-- Page scripts -->
    <script src="../js/custom.min.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/cookies.js"></script>

    <script src="../js/aws-sdk.min.js"></script>
    <script src="../js/amazon-cognito-auth.min.js"></script>
    <script src="../js/amazon-cognito-identity.min.js"></script>
    <script src="../js/auth.js"></script>

    <script>

        isLoggedIn();

        var apiPathBotHub = `https://purecloud-bot-hub.herokuapp.com/api/v1/users/${cognitoUser.username}`;

        // Import Bars
        $("#topbar").load("topbar.html");
        $("#leftsidebar").load("leftsidebar.html");
        $("#rightsidebar").load("rightsidebar.html");
        $("#footer").load("footer.html");

        // Configuration objects
        var channels = {};
        var facebookMessengerConfiguration = {};
        var skypeConfiguration = {};
        var azureBotConfiguration = {};
        var googleDialogflowConfiguration = {};
        var ibmWatsonConfiguration = {};
        var genesysPureCloudConfiguration = {};

        //#region Form validation

        var validator = $("#new-request").validate({
            rules: {
                name: {
                    required: true
                },
                primaryOutput: {
                    required: {
                        depends: function (element) {
                            return $("#primaryOutput").val() == "";
                        }
                    }
                },
                channels: {
                    required: {
                        depends: function (element) {
                            console.log("Check:", channels.web || channels.messenger || channels.skype);
                            return channels.web || channels.messenger || channels.skype;
                        }
                    }
                }
            },
            onfocusout: false,
            onkeyup: false,
            errorClass: "text-danger",
            invalidHandler: function (event, validator) {
                // 'this' refers to the form
                var errors = validator.numberOfInvalids();
                if (errors) {
                    showMessage("Missing fields", true);
                }
            }
        });

        var facebookMessengerValidator = $("#new-request-facebookmessenger").validate({
            rules: {
                facebookMessengerPageAccessToken: {
                    required: true
                },
                facebookMessengerPageId: {
                    required: true
                }
            },
            onfocusout: false,
            onkeyup: false,
            errorClass: "alert alert-danger",
            errorPlacement: function (error, element) {
                error.insertBefore(element.parent().children("br"));
            },
            invalidHandler: function (event, validator) {
                // 'this' refers to the form
                var errors = validator.numberOfInvalids();
                if (errors) {
                    showMessage("Missing fields", true);
                }
            }
        });

        var skypeValidator = $("#new-request-skype").validate({
            rules: {
                skypePageAccessToken: {
                    required: true
                },
                skypePageId: {
                    required: true
                }
            },
            onfocusout: false,
            onkeyup: false,
            errorClass: "alert alert-danger",
            errorPlacement: function (error, element) {
                error.insertBefore(element.parent().children("br"));
            },
            invalidHandler: function (event, validator) {
                // 'this' refers to the form
                var errors = validator.numberOfInvalids();
                if (errors) {
                    showMessage("Missing fields", true);
                }
            }
        });

        var azureBotValidator = $("#new-request-azurebot").validate({
            rules: {
                azurebotApiKey: {
                    required: true
                }
            },
            onfocusout: false,
            onkeyup: false,
            errorClass: "alert alert-danger",
            errorPlacement: function (error, element) {
                error.insertBefore(element.parent().children("br"));
            },
            invalidHandler: function (event, validator) {
                // 'this' refers to the form
                var errors = validator.numberOfInvalids();
                if (errors) {
                    showMessage("Missing fields", true);
                }
            }
        });

        var googleDialogflowValidator = $("#new-request-googledialogflow").validate({
            rules: {
                googledialogflowApiKey: {
                    required: true
                },
                googledialogflowUrl: {
                    required: true
                },
                googledialogflowWorkspaceId: {
                    required: true
                }
            },
            onfocusout: false,
            onkeyup: false,
            errorClass: "alert alert-danger",
            errorPlacement: function (error, element) {
                error.insertBefore(element.parent().children("br"));
            },
            invalidHandler: function (event, validator) {
                // 'this' refers to the form
                var errors = validator.numberOfInvalids();
                if (errors) {
                    showMessage("Missing fields", true);
                }
            }
        });

        var ibmWatsonValidator = $("#new-request-ibmwatson").validate({
            rules: {
                ibmWatsonApiKey: {
                    required: true
                },
                ibmWatsonUrl: {
                    required: true
                },
                ibmWatsonWorkspaceId: {
                    required: true
                }
            },
            onfocusout: false,
            onkeyup: false,
            errorClass: "alert alert-danger",
            errorPlacement: function (error, element) {
                error.insertBefore(element.parent().children("br"));
            },
            invalidHandler: function (event, validator) {
                // 'this' refers to the form
                var errors = validator.numberOfInvalids();
                if (errors) {
                    showMessage("Missing fields", true);
                }
            }
        });

        var genesysPureCloudValidator = $("#new-request-genesyspurecloud").validate({
            rules: {
                pureCloudOrganizationId: {
                    required: true
                },
                pureCloudDeploymentId: {
                    required: true
                },
                pureCloudEnvironment: {
                    required: true
                },
                pureCloudQueueName: {
                    required: true
                }
            },
            onfocusout: false,
            onkeyup: false,
            errorClass: "alert alert-danger",
            errorPlacement: function (error, element) {
                error.insertBefore(element.parent().children("br"));
            },
            invalidHandler: function (event, validator) {
                // 'this' refers to the form
                var errors = validator.numberOfInvalids();
                if (errors) {
                    showMessage("Missing fields", true);
                }
            }
        });

        //#endregion Form validation

        //#region Modals

        // Change background when opening modals
        $(document).on('show.bs.modal', '.modal', function (event) {
            var zIndex = 1040 + (10 * $('.modal:visible').length);
            $(this).css('z-index', zIndex);
            setTimeout(function () {
                $('.modal-backdrop').not('.modal-stack').css('z-index', zIndex - 1).addClass('modal-stack');
            }, 0);
        });

        function resetSettingsModal() {
            $("#settings #title").html("New Chatbot");
            $("#settings #name").val("");
            $("#settings #primaryOutput").val("");
            $("#settings #close").text('Create');
            channels = {};
            resetFacebookMessengerModal();
            resetSkypeModal();
            resetAzureBotModal();
            resetGoogleDialogflowModal();
            resetIbmWatsonModal();
            resetGenesysPureCloudModal();
            $("#settings #close").unbind().click(function () {
                console.log('Submitting request...');

                if (!$("#new-request").valid()) {
                    return;
                }

                // Base data
                var data = {
                    "name": $("#settings #name").val(),
                    "config": {
                        "primaryRoute": $("#settings #primaryOutput").val(),
                        "channels": channels
                    }
                };

                console.log("data:", data);

                $.ajax({
                    url: `${apiPathBotHub}/configurationobjects`,
                    dataType: "json",
                    method: "POST",
                    beforeSend: setRequiredHeaders,
                    data: data
                }).done((data, textStatus, jqXHR) => {
                    switch (jqXHR.status) {
                        case 201:
                            console.log('Request submitted', data);
                            $("#settings").modal('toggle');
                            showMessage('Request submitted');
                            loadCards();
                            break;
                        default:
                            break;
                    }
                }).fail((error) => {
                    console.error(error);
                    showMessage(error.responseText);
                });
            });
        }

        function resetFacebookMessengerModal() {
            $("#facebookmessenger #facebookMessengerPageAccessToken").val("");
            $("#facebookmessenger #facebookMessengerPageId").val("");
            $("#facebookmessengerchannel").removeClass("btn-success").addClass("btn-default");
            $("#facebookmessengerchannelsign").addClass("fa-plus-circle");
            $("#facebookmessengerchannelreset").hide();
            delete channels.messenger;
            $("#facebookmessenger #close").unbind().click(function () {
                if (!$("#new-request-facebookmessenger").valid()) {
                    return;
                }
                facebookMessengerConfiguration.type = "input";
                facebookMessengerConfiguration.pageAccessToken = $("#facebookmessenger #facebookMessengerPageAccessToken").val();
                facebookMessengerConfiguration.id = $("#facebookmessenger #facebookMessengerPageId").val();
                channels.messenger = facebookMessengerConfiguration;
                console.log("Channels: ", channels);
                $("#facebookmessengerchannel").removeClass("btn-default").addClass("btn-success");
                $("#facebookmessengerchannelsign").removeClass("fa-plus-circle");
                $("#facebookmessengerchannelreset").show();
                $("#facebookmessenger").modal("toggle");
            });
        }

        function resetSkypeModal() {
            $("#skype #skypePageAccessToken").val("");
            $("#skype #skypePageId").val("");
            $("#skypechannel").removeClass("btn-success").addClass("btn-default");
            $("#skypechannelsign").addClass("fa-plus-circle");
            $("#skypechannelreset").hide();
            delete channels.skype;
            $("#skype #close").unbind().click(function () {
                if (!$("#new-request-skype").valid()) {
                    return;
                }
                skypeConfiguration.type = "input";
                skypeConfiguration.pageAccessToken = $("#skype #skypePageAccessToken").val();
                skypeConfiguration.id = $("#skype #skypePageId").val();
                channels.skype = skypeConfiguration;
                console.log("Channels: ", channels);
                $("#skypechannel").removeClass("btn-default").addClass("btn-success");
                $("#skypechannelsign").removeClass("fa-plus-circle");
                $("#skypechannelreset").show();
                $("#skype").modal("toggle");
            });
        }

        function resetAzureBotModal() {
            $("#azurebot #azurebotApiKey").val("");
            $("#azurebot #azurebotUrl").val("");
            $("#azurebot #azurebotWorkspaceId").val("");
            $("#azurebotchannel").removeClass("btn-success").addClass("btn-default");
            $("#azurebotchannelsign").addClass("fa-plus-circle");
            delete channels.azurebot;
            $("#azurebotchannelreset").hide();
            $("#azurebot #close").unbind().click(function () {
                if (!$("#new-request-azurebot").valid()) {
                    return;
                }
                azureBotConfiguration.type = "bot";
                azureBotConfiguration.apiKey = $("#azurebot #azurebotApiKey").val();
                channels.azurebot = azureBotConfiguration;
                console.log("Channels: ", channels);
                $("#azurebotchannel").removeClass("btn-default").addClass("btn-success");
                $("#azurebotchannelsign").removeClass("fa-plus-circle");
                $("#azurebotchannelreset").show();
                $("#azurebot").modal("toggle");
            });
        }

        function resetGoogleDialogflowModal() {
            $("#googledialogflow #googledialogflowApiKey").val("");
            $("#googledialogflow #googledialogflowUrl").val("");
            $("#googledialogflow #googledialogflowWorkspaceId").val("");
            $("#googledialogflowchannel").removeClass("btn-success").addClass("btn-default");
            $("#googledialogflowchannelsign").addClass("fa-plus-circle");
            $("#googledialogflowchannelreset").hide();
            delete channels.googledialogflow;
            $("#googledialogflow #close").unbind().click(function () {
                if (!$("#new-request-googledialogflow").valid()) {
                    return;
                }
                googleDialogflowConfiguration.type = "bot";
                googleDialogflowConfiguration.apiKey = $("#googledialogflow #googledialogflowApiKey").val();
                googleDialogflowConfiguration.url = $("#googledialogflow #googledialogflowUrl").val();
                googleDialogflowConfiguration.workspaceId = $("#googledialogflow #googledialogflowWorkspaceId").val();
                channels.googledialogflow = googleDialogflowConfiguration;
                console.log("Channels: ", channels);
                $("#googledialogflowchannel").removeClass("btn-default").addClass("btn-success");
                $("#googledialogflowchannelsign").removeClass("fa-plus-circle");
                $("#googledialogflowchannelreset").show();
                $("#googledialogflow").modal("toggle");
            });
        }

        function resetIbmWatsonModal() {
            $("#ibmwatson #ibmWatsonApiKey").val("");
            $("#ibmwatson #ibmWatsonUrl").val("");
            $("#ibmwatson #ibmWatsonWorkspaceId").val("");
            $("#ibmwatsonchannel").removeClass("btn-success").addClass("btn-default");
            $("#ibmwatsonchannelsign").addClass("fa-plus-circle");
            $("#ibmwatsonchannelreset").hide();
            delete channels.ibmwatson;
            $("#ibmwatson #close").unbind().click(function () {
                if (!$("#new-request-ibmwatson").valid()) {
                    return;
                }
                ibmWatsonConfiguration.type = "bot";
                ibmWatsonConfiguration.apiKey = $("#ibmwatson #ibmWatsonApiKey").val();
                ibmWatsonConfiguration.url = $("#ibmwatson #ibmWatsonUrl").val();
                ibmWatsonConfiguration.workspaceId = $("#ibmwatson #ibmWatsonWorkspaceId").val();
                channels.ibmwatson = ibmWatsonConfiguration;
                console.log("Channels (w/ IBM Watson): ", channels);
                $("#ibmwatsonchannel").removeClass("btn-default").addClass("btn-success");
                $("#ibmwatsonchannelsign").removeClass("fa-plus-circle");
                $("#ibmwatsonchannelreset").show();
                $("#ibmwatson").modal("toggle");
            });
        }

        function resetGenesysPureCloudModal() {
            $("#genesyspurecloud #pureCloudOrganizationId").val("");
            $("#genesyspurecloud #pureCloudDeploymentId").val("");
            $("#genesyspurecloud #pureCloudEnvironment").val("");
            $("#genesyspurecloud #pureCloudQueueName").val("");
            $("#genesyspurecloudchannel").removeClass("btn-success").addClass("btn-default");
            $("#genesyspurecloudchannelsign").addClass("fa-plus-circle");
            delete channels.purecloud;
            $("#genesyspurecloudchannelreset").hide();
            $("#genesyspurecloud #close").unbind().click(function () {
                if (!$("#new-request-genesyspurecloud").valid()) {
                    return;
                }
                genesysPureCloudConfiguration.type = "operator";
                genesysPureCloudConfiguration.organizationId = $("#genesyspurecloud #pureCloudOrganizationId").val();
                genesysPureCloudConfiguration.deploymentId = $("#genesyspurecloud #pureCloudDeploymentId").val();
                genesysPureCloudConfiguration.env = $("#genesyspurecloud #pureCloudEnvironment").val();
                genesysPureCloudConfiguration.queueName = $("#genesyspurecloud #pureCloudQueueName").val();
                channels.purecloud = genesysPureCloudConfiguration;
                console.log("Channels: ", channels);
                $("#genesyspurecloudchannel").removeClass("btn-default").addClass("btn-success");
                $("#genesyspurecloudchannelsign").removeClass("fa-plus-circle").addClass("fa-check-circle");
                $("#genesyspurecloudchannelreset").show();
                $("#genesyspurecloud").modal("toggle");
            });
        }

        //#region Reset buttons

        $("#facebookmessengerchannelreset").on('click', () => {
            resetFacebookMessengerModal();
        })

        $("#skypechannelreset").on('click', () => {
            resetSkypeModal();
        })

        $("#azurebotchannelreset").on('click', () => {
            resetAzureBotModal();
        })

        $("#googledialogflowchannelreset").on('click', () => {
            resetGoogleDialogflowModal();
        })

        $("#ibmwatsonchannelreset").on('click', () => {
            resetIbmWatsonModal();
        })

        $("#genesyspurecloudchannelreset").on('click', () => {
            resetGenesysPureCloudModal();
        })

        // Clear settings modal when hidden
        $("#settings").on("hidden.bs.modal", function () {
            resetSettingsModal();
        });

        //#endregion Reset buttons

        //#region Clear modals if invalid

        // Clear facebook messenger modal when hidden if data is invalid
        $("#facebookmessenger").on("hidden.bs.modal", function () {
            if (!$("#facebookmessenger #facebookMessengerPageAccessToken").val() || !$("#facebookmessenger #facebookMessengerPageId").val()) {
                resetFacebookMessengerModal();
            }
        });

        // Clear skype modal when hidden if data is invalid
        $("#skype").on("hidden.bs.modal", function () {
            if (!$("#skype #skypePageAccessToken").val() || !$("#skype #skypePageId").val()) {
                resetSkypeModal();
            }
        });

        // Clear azure bot modal when hidden if data is invalid
        $("#azurebot").on("hidden.bs.modal", function () {
            if (!$("#azurebot #azurebotApiKey").val()) {
                resetAzureBotModal();
            }
        });

        // Clear google dialogflow modal when hidden if data is invalid
        $("#googledialogflow").on("hidden.bs.modal", function () {
            if (!$("#googledialogflow #googledialogflowApiKey").val() || !$("#googledialogflow #googledialogflowUrl").val() || !$("#googledialogflow #googledialogflowWorkspaceId").val()) {
                resetAzureBotModal();
            }
        });

        // Clear google dialogflow modal when hidden if data is invalid
        $("#ibmwatson").on("hidden.bs.modal", function () {
            if (!$("#ibmwatson #ibmWatsonApiKey").val() || !$("#ibmwatson #ibmWatsonUrl").val() || !$("#ibmwatson #ibmWatsonWorkspaceId").val()) {
                resetIbmWatsonModal();
            }
        });

        // Clear genesys purecloud modal when hidden if data is invalid
        $("#genesyspurecloud").on("hidden.bs.modal", function () {
            if (!$("#genesyspurecloud #pureCloudOrganizationId").val() || !$("#genesyspurecloud #pureCloudDeploymentId").val() || !$("#genesyspurecloud #pureCloudEnvironment").val() || !$("#genesyspurecloud #pureCloudQueueName").val()) {
                resetGenesysPureCloudModal();
            }
        });

        //#endregion

        //#endregion Modals

        // Refresh button
        $("#refresh").on("click", () => {
            loadCards();
        });

        // Create a new request
        function addCard(id, userId, name, config, createdAt, updatedAt) {

            // Add card to accordion
            var cardDiv = $("<div />", { class: "card border shadow" });

            //#region Header

            var cardHeader = $("<div />", { class: "card-header" }).appendTo(cardDiv);

            var headerContent = $("<a />", { class: "card-link", "data-toggle": "collapse", href: "#collapse_" + id }).appendTo(cardHeader);

            //#region Job name

            var jobNameSpan = $("<span />", { class: "text-dark" }).html("&nbsp; &nbsp;" + name).appendTo(headerContent);

            //#endregion

            //#region Delete Icon

            var deleteIcon = $("<i />", { class: "far fa-lg fa-trash-alt text-danger float-right ml-2 pt-1" }).appendTo(headerContent);
            deleteIcon.on("click", function () {
                swal({
                    title: "Are you sure?",
                    text: "You will not be able to recover this configuration!",
                    icon: "warning",
                    buttons: {
                        cancel: true,
                        confirm: {
                            visible: true,
                            text: "Yes, delete it!",
                            closeModal: true
                        }
                    },
                    dangerMode: true
                }).then((willDelete) => {
                    if (willDelete) {
                        $.ajax({
                            url: `${apiPathBotHub}/configurationobjects/${encodeURI(id)}`,
                            dataType: "json",
                            beforeSend: setRequiredHeaders,
                            method: "DELETE",
                        }).done((data, textStatus, jqXHR) => {
                            if (jqXHR.status == 204) {
                                console.log('Request deleted');
                                showMessage(`'${name}' deleted`);
                                loadCards();
                                return;
                            }
                        }).fail(handleQueryError);
                    }
                });
            });

            //#endregion

            //#region Edit Icon

            var editIcon = $("<i />", { class: "fas fa-lg fa-edit text-dark float-right ml-2 pt-1", "data-toggle": "modal", "data-target": "#settings", style: "cursor:pointer" }).appendTo(headerContent);
            editIcon.on("click", function (e) {
                console.log("Editing request...", config);
                $("#settings #title").html(name);
                $("#settings #name").val(name);
                $("#settings #primaryOutput").val(config.primaryRoute);

                //Check every channel
                if (config.channels.messenger) {
                    console.log("Found a config for Facebook messenger");
                    channels.messenger = config.channels.messenger;
                    $("#facebookmessenger #facebookMessengerPageAccessToken").val(channels.messenger.pageAccessToken);
                    $("#facebookmessenger #facebookMessengerPageId").val(channels.messenger.id);
                    $("#facebookmessengerchannel").removeClass("btn-default").addClass("btn-success");
                    $("#facebookmessengerchannelsign").removeClass("fa-plus-circle");
                    $("#facebookmessengerchannelreset").show();
                }

                if (config.channels.skype) {
                    console.log("Found a config for Skype");
                    channels.skype = config.channels.skype;
                    $("#skype #skypePageAccessToken").val(channels.skype.pageAccessToken);
                    $("#skype #skypePageId").val(channels.skype.id);
                    $("#skypechannel").removeClass("btn-default").addClass("btn-success");
                    $("#skypechannelsign").removeClass("fa-plus-circle");
                    $("#skypechannelreset").show();
                }

                if (config.channels.azurebot) {
                    console.log("Found a config for Azure Bot");
                    channels.azurebot = config.channels.azurebot;
                    $("#azurebot #azurebotApiKey").val(channels.azurebot.apiKey);
                    $("#azurebotchannel").removeClass("btn-default").addClass("btn-success");
                    $("#azurebotchannelsign").removeClass("fa-plus-circle");
                    $("#azurebotchannelreset").show();
                }

                if (config.channels.googledialogflow) {
                    console.log("Found a config for Google Dialogflow");
                    channels.googledialogflow = config.channels.googledialogflow;
                    $("#googledialogflow #googledialogflowApiKey").val(channels.googledialogflow.apiKey);
                    $("#googledialogflow #googledialogflowUrl").val(channels.googledialogflow.url);
                    $("#googledialogflow #googledialogflowWorkspaceId").val(channels.googledialogflow.workspaceId);
                    $("#googledialogflowchannel").removeClass("btn-default").addClass("btn-success");
                    $("#googledialogflowchannelsign").removeClass("fa-plus-circle");
                    $("#googledialogflowchannelreset").show();
                }

                if (config.channels.ibmwatson) {
                    console.log("Found a config for IBM Watson");
                    channels.ibmwatson = config.channels.ibmwatson;
                    $("#ibmwatson #ibmWatsonApiKey").val(channels.ibmwatson.apiKey);
                    $("#ibmwatson #ibmWatsonUrl").val(channels.ibmwatson.url);
                    $("#ibmwatson #ibmWatsonWorkspaceId").val(channels.ibmwatson.workspaceId);
                    $("#ibmwatsonchannel").removeClass("btn-default").addClass("btn-success");
                    $("#ibmwatsonchannelsign").removeClass("fa-plus-circle");
                    $("#ibmwatsonchannelreset").show();
                }

                if (config.channels.purecloud) {
                    console.log("Found a config for Genesys PureCloud");
                    channels.purecloud = config.channels.purecloud;
                    $("#genesyspurecloud #pureCloudOrganizationId").val(channels.purecloud.organizationId);
                    $("#genesyspurecloud #pureCloudDeploymentId").val(channels.purecloud.deploymentId);
                    $("#genesyspurecloud #pureCloudEnvironment").val(channels.purecloud.env);
                    $("#genesyspurecloud #pureCloudQueueName").val(channels.purecloud.queueName);
                    $("#genesyspurecloudchannel").removeClass("btn-default").addClass("btn-success");
                    $("#genesyspurecloudchannelsign").removeClass("fa-plus-circle");
                    $("#genesyspurecloudchannelreset").show();
                }

                $("#settings #close").text('Save');
                validator.resetForm();
                $("#settings #close").unbind().click(function () {
                    console.log('Saving request...');

                    if (!$("#new-request").valid()) {
                        return;
                    }

                    // Base data
                    var data = {
                        "name": $("#settings #name").val(),
                        "config": {
                            "primaryRoute": $("#settings #primaryOutput").val(),
                            "channels": channels
                        }
                    };

                    console.log("data:", data);

                    $.ajax({
                        url: `${apiPathBotHub}/configurationobjects/${id}`,
                        dataType: "json",
                        method: "PATCH",
                        beforeSend: setRequiredHeaders,
                        data: data
                    }).done((data, textStatus, jqXHR) => {
                        switch (jqXHR.status) {
                            case 200:
                                console.log('Request submitted', data);
                                $("#settings").modal('toggle');
                                showMessage('Request submitted');
                                loadCards();
                                break;
                            default:
                                break;
                        }
                    }).fail((error) => {
                        console.error(error);
                        showMessage(error.responseText);
                    });
                });
            });

            //#endregion

            //#region Last Updated

            var lastUpdatedDiv = $("<div />", { class: "float-right text-dark ml-2" }).appendTo(headerContent);
            var updatedSection = $("<i />", { class: "fas fa-calendar-alt" }).appendTo(lastUpdatedDiv);
            lastUpdatedDiv.append(` ${moment(updatedAt).fromNow()}`);

            //#endregion

            //#endregion Header

            //#region Body

            //#endregion

            return cardDiv;
        }

        // Load requests via API call
        function loadCards() {

            // Remove any existing cards
            $("#accordion").empty();

            console.log("Getting all requests...");

            // Call API
            $.ajax({
                url: `${apiPathBotHub}/configurationobjects`,
                dataType: "json",
                beforeSend: setRequiredHeaders,
            }).done((data, textStatus, jqXHR) => {
                switch (jqXHR.status) {
                    case 200:
                        let requests = data;
                        console.log('requests:', requests);
                        requests.forEach(currentRequest => {
                            console.log('Current request:', currentRequest);

                            // Add item
                            $("#accordion").append(addCard(
                                currentRequest._id,
                                currentRequest.userId,
                                currentRequest.name,
                                currentRequest.config,
                                currentRequest.createdAt,
                                currentRequest.updatedAt
                            )
                            );
                        });
                        break;
                    default:
                        console.error("Unknown status code: " + jqXHR.status);
                        break;
                }
            }).fail(function (error) {
                console.error(error);
                showMessage("An error occurred while retrieving requests", true);
            });
        }

        loadCards();

        resetSettingsModal();
        resetFacebookMessengerModal();
        resetSkypeModal();
        resetAzureBotModal();
        resetGoogleDialogflowModal();
        resetIbmWatsonModal();
        resetGenesysPureCloudModal();

    </script>
</body>

</html>