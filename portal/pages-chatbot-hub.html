<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Tell the browser to be responsive to screen width -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <!-- Favicon icon -->
    <link rel="icon" type="image/ico" sizes="16x16" href="../images/favicon.ico">
    <title>Smart Cloudi - Chatbot Hub</title>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-136094582-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-136094582-1');
    </script>
    <!-- Custom CSS -->
    <link href="css/style.min.css" rel="stylesheet">
    <link href="../css/stylish-tooltip.css" rel="stylesheet">
    <link href="../css/switchery.css" rel="stylesheet" />
    <link href="../css/jquery-ui.min.css" rel="stylesheet" />
    <link href="../css/jquery.toast.min.css" rel="stylesheet">
    <link href="../css/perfect-scrollbar.css">
    <!-- page css -->
    <link href="css/inbox.css" rel="stylesheet">
    <link rel="stylesheet" href="css/pages-chatbot-hub.css">
</head>

<body class="skin-purple-dark fixed-layout">
    <!-- ============================================================== -->
    <!-- Preloader - style you can find in spinners.css -->
    <!-- ============================================================== -->
    <div class="preloader">
        <div class="loader">
            <div class="loader__figure"></div>
            <p class="loader__label">Smart Cloudi</p>
        </div>
    </div>
    <!-- ============================================================== -->
    <!-- Main wrapper - style you can find in pages.scss -->
    <!-- ============================================================== -->
    <div id="main-wrapper">
        <div id="topbar"></div>
        <div id="leftsidebar"></div>
        <!-- ============================================================== -->
        <!-- Page wrapper  -->
        <!-- ============================================================== -->
        <div class="page-wrapper">
            <!-- ============================================================== -->
            <!-- Container fluid  -->
            <!-- ============================================================== -->
            <div class="container-fluid">
                <!-- ============================================================== -->
                <!-- Bread crumb and right sidebar toggle -->
                <!-- ============================================================== -->
                <div class="row page-titles">
                    <div class="col-md-5 align-self-center">
                        <h4 class="text-themecolor">Chatbot Hub</h4>
                    </div>
                    <div class="col-md-7 align-self-center text-right">
                        <div class="d-flex justify-content-end align-items-center">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                                <li class="breadcrumb-item active">Chatbot Hub</li>
                            </ol>
                            <button type="button" data-toggle="modal" data-target="#settings"
                                class="btn btn-info d-none d-lg-block m-l-15"><i class="fa fa-plus-circle"></i> Create
                                New</button>
                        </div>
                    </div>
                </div>
                <!-- ============================================================== -->
                <!-- End Bread crumb and right sidebar toggle -->
                <!-- ============================================================== -->
            </div>
            <!-- Settings Modal -->
            <div id="settings" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="settingsLabel"
                aria-hidden="true" style="display: none;">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="title"></h4>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        </div>
                        <div class="modal-body">
                            <form id="new-request">
                                <div>
                                    <div class="form-group">
                                        <label for="name">Name</label>
                                        <input type="text" class="form-control" id="name" name="name" required
                                            placeholder="Enter a name for your configuration">
                                    </div>
                                    <div class="form-group">
                                        <label>Inputs</label>
                                        <div class="btn-group" role="group">
                                            <button type="button" data-toggle="modal" data-target="#web"
                                                class="btn btn-default d-none d-lg-block ml-2"><i
                                                    class="fas fa-1x fa-globe" title="Web"></i> Web <i
                                                    class="fas fa-plus-circle"></i></button>
                                            <button type="button" data-toggle="modal" data-target="#facebookmessenger"
                                                class="btn btn-default d-none d-lg-block ml-2"><i
                                                    class="fab fa-1x fa-facebook-messenger"
                                                    title="Facebook Messenger"></i> Facebook Messenger <i
                                                    class="fas fa-plus-circle"></i></button>
                                            <button type="button" data-toggle="modal" data-target="#skype"
                                                class="btn btn-default d-none d-lg-block ml-2"><i
                                                    class="fab fa-1x fa-skype" title="Skype"></i> Skype <i
                                                    class="fas fa-plus-circle"></i></button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Outputs</label>
                                        <div class="btn-group" role="group">
                                            <button type="button" id="azurebotchannel" data-toggle="modal"
                                                data-target="#azurebot"
                                                class="btn btn-default d-none d-lg-block ml-2">Azure Bot <i
                                                    id="azurebotchannelsign" class="fas fa-plus-circle"></i></button>
                                            <button type="button" id="genesyspurecloudchannel" data-toggle="modal"
                                                data-target="#genesyspurecloud"
                                                class="btn btn-default d-none d-lg-block ml-2">Genesys PureCloud <i
                                                    id="genesyspurecloudchannelsign"
                                                    class="fas fa-plus-circle"></i></button>
                                            <button type="button" id="googledialogflowchannel" data-toggle="modal"
                                                data-target="#googledialogflow"
                                                class="btn btn-default d-none d-lg-block ml-2">Google DialogFlow <i
                                                    id="googledialogflowchannelsign"
                                                    class="fas fa-plus-circle"></i></button>
                                            <button type="button" id="ibmwatsonchannel" data-toggle="modal"
                                                data-target="#ibmwatson"
                                                class="btn btn-default d-none d-lg-block ml-2">IBM Watson <i
                                                    id="ibmwatsonchannelsign" class="fas fa-plus-circle"></i></button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Primary Output Channel: </label>
                                        <select id="primaryOutput">
                                            <option value=""></option>
                                            <option value="azurebot">Azure Bot</option>
                                            <option value="genesyspurecloud">Genesys PureCloud</option>
                                            <option value="googledialogflow">Google DialogFlow</option>
                                            <option value="ibmwatson">IBM Watson</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <div id="error" class="text-danger">
                                <span></span>
                            </div>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="button" id="close" class="btn btn-primary waves-effect"></button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Settings Modal -->

            <!-- PureCloud Modal -->
            <div id="genesyspurecloud" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="pureCloudLabel"
                aria-hidden="true" style="display: none;">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="title">Genesys PureCloud</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        </div>
                        <div class="modal-body">
                            <form id="new-request-genesyspurecloud">
                                <div>
                                    <div class="form-group">
                                        <label for="pureCloudClientId">Client Id</label>
                                        <input type="text" class="form-control" id="pureCloudClientId"
                                            name="pureCloudClientId" required placeholder="Enter your OAuth Client Id">
                                    </div>
                                    <div class="form-group">
                                        <label for="pureCloudClientSecret">Client Secret</label>
                                        <input type="password" class="form-control" id="pureCloudClientSecret"
                                            name="pureCloudClientSecret" required
                                            placeholder="Enter your OAuth Client Secret">
                                    </div>
                                    <div class="form-group">
                                        <label>Environment: </label>
                                        <select id="pureCloudEnvironment">
                                            <option value=""></option>
                                            <option value="mypurecloud.com">mypurecloud.com (Americas)</option>
                                            <option value="mypurecloud.com.au">mypurecloud.com.au (Australia/New
                                                Zealand)</option>
                                            <option value="mypurecloud.de">mypurecloud.de (EU/Frankfurt)</option>
                                            <option value="mypurecloud.ie">mypurecloud.ie (EU/Ireland)</option>
                                            <option value="mypurecloud.jp">mypurecloud.jp (Japan)</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <div id="error" class="text-danger">
                                <span></span>
                            </div>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="button" id="close" class="btn btn-primary waves-effect">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End PureCloud Modal -->

            <!-- IBM Watson Modal -->
            <div id="ibmwatson" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="ibmWatsonLabel"
                aria-hidden="true" style="display: none;">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="title">IBM Watson</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        </div>
                        <div class="modal-body">
                            <form id="new-request-ibmwatson">
                                <div>
                                    <div class="form-group">
                                        <label for="ibmWatsonApiKey">API Key</label>
                                        <input type="text" class="form-control" id="ibmWatsonApiKey"
                                            name="ibmWatsonApiKey" required placeholder="Enter your API Key">
                                    </div>
                                    <div class="form-group">
                                        <label for="ibmWatsonUrl">URL</label>
                                        <input type="text" class="form-control" id="ibmWatsonUrl" name="ibmWatsonUrl"
                                            required placeholder="Enter your URL">
                                    </div>
                                    <div class="form-group">
                                        <label for="ibmWatsonWorkspaceId">Workspace Id</label>
                                        <input type="text" class="form-control" id="ibmWatsonWorkspaceId"
                                            name="ibmWatsonWorkspaceId" required placeholder="Enter your Workspace Id">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <div id="error" class="text-danger">
                                <span></span>
                            </div>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="button" id="close" class="btn btn-primary waves-effect">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End IBM Watson Modal -->

            <!-- ============================================================== -->
            <!-- Start Page Content -->
            <!-- ============================================================== -->
            <!-- Alert -->
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                Thank you for using our Chatbot Hub. Click on the <strong>Create New</strong> button on the top-right to
                get started.
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <!-- Page Content -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="row">
                            <div class="col-lg-3 col-md-4">
                                <div class="card-body inbox-panel">
                                    <ul class="list-group list-group-full">
                                        <li class="list-group-item active"> <a href="javascript:void(0)" id="showAll"><i
                                                    class="fas fa-folder"></i> All </a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-lg-9 col-md-8 bg-light border-left">
                                <div class="card-body">
                                    <button type="button" id="refresh" class="btn btn-secondary mr-2 shadow-sm"><i
                                            class="fas fa-sync-alt"></i></button>
                                </div>

                                <div class="container">
                                    <div id="accordion">
                                        <!-- This is where requests will be added dynamically -->
                                    </div>
                                </div>

                                <div class="card-body p-t-0">
                                    <div class="card b-all shadow-none">
                                        <div class="inbox-center table-responsive">
                                            <table class="table table-hover no-wrap">
                                                <tbody id="requests">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ============================================================== -->
            <!-- End Page Content -->
            <!-- ============================================================== -->
            <!-- ============================================================== -->
            <!-- Right sidebar -->
            <!-- ============================================================== -->
            <div id="rightsidebar"></div>
            <!-- ============================================================== -->
            <!-- End Right sidebar -->
            <!-- ============================================================== -->
        </div>
        <!-- ============================================================== -->
        <!-- End Container fluid  -->
        <!-- ============================================================== -->
    </div>
    <!-- ============================================================== -->
    <!-- End Page wrapper  -->
    <!-- ============================================================== -->
    <div id="footer"></div>
    </div>
    <!-- ============================================================== -->
    <!-- End Wrapper -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- All Jquery -->
    <!-- ============================================================== -->
    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../js/popper.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>

    <script src="../js/perfect-scrollbar.min.js"></script>
    <script src="../js/perfect-scrollbar.jquery.js"></script>

    <script src="../js/jquery-ui.min.js"></script>

    <script src="../js/waves.js"></script>
    <script src="../js/sidebarmenu.js"></script>

    <script src="../js/jquery.magnific-popup.min.js"></script>
    <script src="../js/jquery.nav.js"></script>

    <script src="../js/jquery.toast.min.js"></script>
    <script src="../js/sweetalert.min.js"></script>

    <script src="../js/jquery.validate.min.js"></script>
    <script src="../js/additional-methods.min.js"></script>

    <script src="../js/moment.min.js"></script>
    <script src="../js/later.min.js"></script>
    <script src="../js/prettycron.js"></script>
    <script src="../js/cron-ui.min.js"></script>

    <!-- Page scripts -->
    <script src="../js/custom.min.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/cookies.js"></script>

    <script src="../js/aws-sdk.min.js"></script>
    <script src="../js/amazon-cognito-auth.min.js"></script>
    <script src="../js/amazon-cognito-identity.min.js"></script>
    <script src="../js/auth.js"></script>

    <script>

        // Import Bars
        $("#topbar").load("topbar.html");
        $("#leftsidebar").load("leftsidebar.html");
        $("#rightsidebar").load("rightsidebar.html");
        $("#footer").load("footer.html");

        // Configuration objects
        var channels = {};
        var genesysPureCloudConfiguration = {};
        var ibmWatsonConfiguration = {};

        //#region Form validation

        var validator = $("#new-request").validate({
            rules: {
                name: {
                    required: true
                }
            },
            onfocusout: false,
            onkeyup: false,
            errorClass: "alert alert-danger",
            errorPlacement: function (error, element) {
                error.insertBefore(element.parent().children("br"));
            },
            invalidHandler: function (event, validator) {
                // 'this' refers to the form
                var errors = validator.numberOfInvalids();
                if (errors) {
                    showMessage("Missing fields", true);
                }
            }
        });

        var genesysPureCloudValidator = $("#new-request-genesyspurecloud").validate({
            rules: {
                pureCloudClientId: {
                    required: true
                },
                pureCloudClientSecret: {
                    required: true
                },
                pureCloudEnvironment: {
                    required: true
                }
            },
            onfocusout: false,
            onkeyup: false,
            errorClass: "alert alert-danger",
            errorPlacement: function (error, element) {
                error.insertBefore(element.parent().children("br"));
            },
            invalidHandler: function (event, validator) {
                // 'this' refers to the form
                var errors = validator.numberOfInvalids();
                if (errors) {
                    showMessage("Missing fields", true);
                }
            }
        });

        var ibmWatsonValidator = $("#new-request-ibmwatson").validate({
            rules: {
                ibmWatsonApiKey: {
                    required: true
                },
                ibmWatsonUrl: {
                    required: true
                },
                ibmWatsonWorkspaceId: {
                    required: true
                }
            },
            onfocusout: false,
            onkeyup: false,
            errorClass: "alert alert-danger",
            errorPlacement: function (error, element) {
                error.insertBefore(element.parent().children("br"));
            },
            invalidHandler: function (event, validator) {
                // 'this' refers to the form
                var errors = validator.numberOfInvalids();
                if (errors) {
                    showMessage("Missing fields", true);
                }
            }
        });

        //#endregion Form validation

        isLoggedIn();

        var apiPathBotHub = `https://purecloud-bot-hub.herokuapp.com/api/v1/users/${cognitoUser.username}`;

        //#region Modals

        function resetSettingsModal() {
            $("#settings #title").html("New Chatbot");
            $("#settings #name").val("");
            $("#settings #primaryOutput").val("");
            $("#settings #close").text('Create');
            $("#settings #close").unbind().click(function () {
                console.log('Submitting request...');

                if (!$("#new-request").valid()) {
                    return;
                }

                var data = {
                    "originId": "?",
                    "name": $("#settings #name").val(),
                    "config": {
                        "origin": "messenger",
                        "primaryRoute": $("#settings #primaryOutput").val(),
                        "channels": {
                            "purecloud": {
                                "clientId": "1231231223",
                                "clientSecret": "xxxxxx",
                                "env": "mypurecloud.ie"
                            },
                            "watson": {
                                "apiKey": "abc",
                                "url": "",
                                "workspaceId": ""
                            }
                        }
                    }
                };

                $.ajax({
                    url: `${apiPathBotHub}/configurationobjects`,
                    dataType: "json",
                    method: "POST",
                    beforeSend: setRequiredHeaders,
                    data: data
                }).done((data, textStatus, jqXHR) => {
                    switch (jqXHR.status) {
                        case 201:
                            console.log('Request submitted', data);
                            $("#settings").modal('toggle');
                            showMessage('Request submitted');
                            loadRequests(showJobs, showCronJobs);
                            break;
                        default:
                            break;
                    }
                }).fail((error) => {
                    console.error(error);
                    showMessage(error.responseText);
                });
            });
        }

        function resetGenesysPureCloudModal() {
            $("#genesyspurecloud #pureCloudClientId").val("");
            $("#genesyspurecloud #pureCloudClientSecret").val("");
            $("#genesyspurecloud #pureCloudEnvironment").val("");
            $("#genesyspurecloud #close").unbind().click(function () {
                if (!$("#new-request-genesyspurecloud").valid()) {
                    return;
                }
                genesysPureCloudConfiguration.clientId = $("#genesyspurecloud #pureCloudClientId").val();
                genesysPureCloudConfiguration.clientSecret = $("#genesyspurecloud #pureCloudClientSecret").val();
                genesysPureCloudConfiguration.env = $("#genesyspurecloud #pureCloudEnvironment").val();
                channels.purecloud = genesysPureCloudConfiguration;
                console.log("Channels: ", channels);
                $("#genesyspurecloudchannel").removeClass("btn-default").addClass("btn-success");
                $("#genesyspurecloudchannelsign").removeClass("fa-plus-circle").addClass("fa-check-circle");
                $("#genesyspurecloud").modal("toggle");
            });
        }

        function resetIbmWatsonModal() {
            $("#ibmwatson #ibmWatsonApiKey").val("");
            $("#ibmwatson #ibmWatsonUrl").val("");
            $("#ibmwatson #ibmWatsonWorkspaceId").val("");
            $("#ibmwatson #close").unbind().click(function () {
                if (!$("#new-request-ibmwatson").valid()) {
                    return;
                }
                ibmWatsonConfiguration.apiKey = $("#ibmwatson #ibmWatsonApiKey").val();
                ibmWatsonConfiguration.url = $("#ibmwatson #ibmWatsonUrl").val();
                ibmWatsonConfiguration.workspaceId = $("#ibmwatson #ibmWatsonWorkspaceId").val();
                channels.ibmwatson = ibmWatsonConfiguration;
                console.log("Channels: ", channels);
                $("#ibmwatsonchannel").removeClass("btn-default").addClass("btn-success");
                $("#ibmwatsonchannelsign").removeClass("fa-plus-circle").addClass("fa-check-circle");
                $("#ibmwatson").modal("toggle");
            });
        }

        // Clear modal when hidden
        $("#settings").on("hidden.bs.modal", function () {
            resetSettingsModal();
        });
        // $("#genesyspurecloud").on("hidden.bs.modal", function () {
        //     resetGenesysPureCloudModal();
        // });

        //#endregion Modals

        // Refresh button
        $("#refresh").on("click", () => {
            loadRequests();
        });

        //#region Left pane buttons

        var showJobs = true;
        var showCronJobs = true;

        $("#showAll").on("click", () => {
            showJobs = true;
            showCronJobs = true;
            loadRequests(showJobs, showCronJobs)
        });
        $("#showJobs").on("click", () => {
            showJobs = true;
            showCronJobs = false;
            loadRequests(showJobs, showCronJobs)
        });
        $("#showCronJobs").on("click", () => {
            showJobs = false;
            showCronJobs = true;
            loadRequests(showJobs, showCronJobs)
        });

        //#endregion

        // Create a new request
        function createRequest(id, originId, userId, name, config, createdAt, updatedAt) {

            // Add card to accordion
            var cardDiv = $("<div />", { class: "card border shadow" });

            //#region Header

            var cardHeader = $("<div />", { class: "card-header" }).appendTo(cardDiv);

            var headerContent = $("<a />", { class: "card-link", "data-toggle": "collapse", href: "#collapse_" + id }).appendTo(cardHeader);

            //#region Job name

            var jobNameSpan = $("<span />", { class: "text-dark" }).html("&nbsp; &nbsp;" + name).appendTo(headerContent);

            //#endregion

            //#region Delete Icon

            var deleteIcon = $("<i />", { class: "far fa-lg fa-trash-alt text-danger float-right ml-2 pt-1" }).appendTo(headerContent);
            deleteIcon.on("click", function () {
                swal({
                    title: "Are you sure?",
                    text: "You will not be able to recover this configuration!",
                    icon: "warning",
                    buttons: {
                        cancel: true,
                        confirm: {
                            visible: true,
                            text: "Yes, delete it!",
                            closeModal: true
                        }
                    },
                    dangerMode: true
                }).then((willDelete) => {
                    if (willDelete) {
                        $.ajax({
                            url: `${apiPathBotHub}/configurationobjects/${encodeURI(id)}`,
                            dataType: "json",
                            beforeSend: setRequiredHeaders,
                            method: "DELETE",
                        }).done((data, textStatus, jqXHR) => {
                            if (jqXHR.status == 204) {
                                console.log('Request deleted');
                                showMessage(`'${name}' deleted`);
                                loadRequests();
                                return;
                            }
                        }).fail(handleQueryError);
                    }
                });
            });

            //#endregion

            //#region Edit Icon

            var editIcon = $("<i />", { class: "fas fa-lg fa-edit text-dark float-right ml-2 pt-1", "data-toggle": "modal", "data-target": "#settings", style: "cursor:pointer" }).appendTo(headerContent);
            editIcon.on("click", function (e) {
                console.log("Editing request...");
                $("#settings #title").html(name);
                $("#settings #name").val(name);
                $("#settings #close").text('Save');
                validator.resetForm();
                $("#settings #close").unbind().click(function () {
                    console.log('Saving request...');

                    if (!$("#new-request").valid()) {
                        return;
                    }

                    //TODO UPDATE THIS
                    var data = {
                        "name": $("#settings #name").val(),
                        "image": "compliance/purecloud-analytics-downloader",
                        "input": [
                            {
                                "name": "environment",
                                "value": $("#settings #environment").val()
                            },
                            {
                                "name": "clientId",
                                "value": $("#settings #clientId").val()
                            },
                            {
                                "name": "clientSecret",
                                "value": $("#settings #clientSecret").val()
                            },
                            {
                                "name": "analyticsIntervalStart",
                                "value": calculateAnalyticsIntervals().analyticsIntervalStart
                            },
                            {
                                "name": "analyticsIntervalStop",
                                "value": calculateAnalyticsIntervals().analyticsIntervalStop
                            },
                            {
                                "name": "doConversationDetail",
                                "value": $("#settings #conversationDetail").is(":checked") ? "1" : "0"
                            },
                            {
                                "name": "doConversationAggregate",
                                "value": $("#settings #conversationAggregate").is(":checked") ? "1" : "0"
                            },
                            {
                                "name": "doUserStatusAggregate",
                                "value": $("#settings #userStatusAggregate").is(":checked") ? "1" : "0"
                            }
                        ]
                    };

                    apiPath = apiPathCloudAnalyticsJobs;

                    if ($("#settings #recurrence").prop("checked")) {
                        data.schedule = cron_ui.currentValue;
                    }

                    console.log('path:', apiPath + "/" + id);
                    console.log('data:', data);

                    $.ajax({
                        url: apiPath + "/" + id,
                        dataType: "json",
                        method: "PATCH",
                        beforeSend: setRequiredHeaders,
                        data: data
                    }).done((data, textStatus, jqXHR) => {
                        switch (jqXHR.status) {
                            case 200:
                                console.log('Request saved');
                                $("#settings").modal('toggle');
                                showMessage('Request saved');
                                loadRequests();
                                break;
                            default:
                                console.error(jqXHR);
                                break;
                        }
                    }).fail((error) => {
                        console.error(error);
                        showMessage(error.responseText, true);
                    });
                });
            });

            //#endregion

            //#region Last Updated

            var lastUpdatedDiv = $("<div />", { class: "float-right text-dark ml-2" }).appendTo(headerContent);
            var updatedSection = $("<i />", { class: "fas fa-calendar-alt" }).appendTo(lastUpdatedDiv);
            lastUpdatedDiv.append(` ${moment(updatedAt).fromNow()}`);

            //#endregion

            //#endregion Header

            //#region Body

            //#endregion

            return cardDiv;
        }

        // Load requests via API call
        function loadRequests() {

            // Remove any existing cards
            $("#accordion").empty();

            console.log("Getting all requests...");

            // Call API
            $.ajax({
                url: `${apiPathBotHub}/configurationobjects`,
                dataType: "json",
                beforeSend: setRequiredHeaders,
            }).done((data, textStatus, jqXHR) => {
                switch (jqXHR.status) {
                    case 200:
                        let requests = data;
                        console.log('requests:', requests);
                        requests.forEach(currentRequest => {
                            console.log('Current request:', currentRequest);

                            // Add item
                            $("#accordion").append(createRequest(
                                currentRequest._id,
                                currentRequest.originId,
                                currentRequest.userId,
                                currentRequest.name,
                                currentRequest.config,
                                currentRequest.createdAt,
                                currentRequest.updatedAt
                            )
                            );
                        });
                        break;
                    default:
                        console.error("Unknown status code: " + jqXHR.status);
                        break;
                }
            }).fail(function (error) {
                console.error(error);
                showMessage("An error occurred while retrieving requests", true);
            });
        }

        loadRequests();
        resetSettingsModal();
        resetGenesysPureCloudModal();
        resetIbmWatsonModal();

    </script>
</body>

</html>